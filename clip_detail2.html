<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Clip Detail ‚Äî OU WBB Defensive Analytics</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ou:#841617; --ou-d:#6C1116; --cream:#FDF9E8;
  --page:#0a0a0a; --panel:#141414; --panel-b:#1f1f1f;
  --ink:#f5f5f2; --muted:#94a3b8; --line:#2a2a2a;
}

* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
  background:var(--page); color:var(--ink); line-height:1.5;
  -webkit-font-smoothing:antialiased;
}

/* Header */
.header {
  background:linear-gradient(180deg,#1a1a1a,#0f0f0f);
  border-bottom:1px solid var(--panel-b);
  padding:1rem 1.5rem;
  position:sticky; top:0; z-index:100;
  box-shadow:0 2px 12px rgba(0,0,0,.5);
}
.header-content {
  max-width:1400px; margin:0 auto;
  display:flex; align-items:center; justify-content:space-between;
}
.header h1 {
  font-size:1.25rem; font-weight:600; letter-spacing:0.3px;
}
.header-actions {
  display:flex; align-items:center; gap:1rem;
}
.btn {
  background:var(--panel-b); border:1px solid var(--line);
  color:var(--ink); padding:0.5rem 1rem; border-radius:6px;
  font-size:0.875rem; cursor:pointer; transition:all .2s;
}
.btn:hover { background:var(--ou); border-color:var(--ou); }
.btn.primary { background:var(--ou); border-color:var(--ou); }
.btn.primary:hover { background:var(--ou-d); }

/* Main Container */
.container {
  max-width:1400px; margin:0 auto; padding:1rem 1.5rem;
}

/* Clip Info Bar */
.clip-info-bar {
  background:var(--panel); border:1px solid var(--panel-b);
  border-radius:10px; padding:0.6rem 1rem; margin-bottom:0.75rem;
  display:flex; align-items:center; justify-content:space-between;
}
.clip-title {
  font-size:1.05rem; font-weight:600;
}
.clip-meta {
  display:flex; align-items:center; gap:1.5rem;
  font-size:0.75rem; color:var(--muted);
}
.clip-meta-item strong {
  color:var(--ink); font-weight:500;
}

/* Main Content Layout */
.main-content {
  margin-bottom:1.25rem;
}

/* Video Section */
.video-section {
  background:var(--panel); border:1px solid var(--panel-b);
  border-radius:10px; padding:1rem;
  max-width:1000px; margin:0 auto 1rem;
}
.video-container {
  position:relative; width:100%; 
  height:520px;
  background:#000; border-radius:8px; overflow:hidden;
  display:flex; align-items:center; justify-content:center;
}
.video-placeholder {
  color:var(--muted); font-size:1rem;
}

/* Analytics Section */
.analytics-section {
  background:var(--panel); border:1px solid var(--panel-b);
  border-radius:10px; padding:0.875rem;
}
.analytics-header {
  display:flex; align-items:center; gap:0.6rem;
  margin-bottom:0.75rem; padding-bottom:0.6rem;
  border-bottom:2px solid var(--ou);
}
.analytics-icon {
  font-size:1.125rem; color:var(--ou);
}
.analytics-title {
  font-size:1rem; font-weight:600;
}

/* Stats Summary */
.stats-summary {
  display:grid; grid-template-columns:repeat(4, 1fr);
  gap:0.6rem;
}

.stat-card {
  background:var(--panel-b); border:1px solid var(--line);
  border-radius:6px; padding:0.6rem; text-align:center;
}

.stat-value {
  font-size:1.35rem; font-weight:700; color:var(--ou);
  font-family:'JetBrains Mono', monospace;
}

.stat-label {
  font-size:0.7rem; color:var(--muted); margin-top:0.15rem;
}

.notes-box {
  background:var(--panel-b); border:1px solid var(--line);
  border-radius:6px; padding:0.6rem; margin-top:0.6rem;
}
.notes-label {
  font-size:0.7rem; font-weight:500; color:var(--muted);
  text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.35rem;
}
.notes-value {
  font-size:0.825rem; color:var(--ink); line-height:1.4;
}

/* Accordion Sections */
.accordion-container {
  display:flex; flex-direction:column; gap:1rem;
}

.accordion-section {
  background:var(--panel); border:1px solid var(--panel-b);
  border-radius:10px; overflow:hidden; transition:all .3s;
}

.accordion-header {
  padding:0.875rem 1.25rem; cursor:pointer;
  display:flex; align-items:center; justify-content:space-between;
  background:var(--panel); border-bottom:1px solid transparent;
  transition:all .2s;
  user-select:none;
}

.accordion-header:hover {
  background:var(--panel-b);
}

.accordion-section.active .accordion-header {
  border-bottom-color:var(--line);
  background:var(--panel-b);
}

.accordion-title {
  font-size:1rem; font-weight:600;
  display:flex; align-items:center; gap:0.75rem;
}

.accordion-icon {
  font-size:1.125rem; color:var(--ou);
}

.accordion-chevron {
  font-size:1.125rem; color:var(--muted);
  transition:transform .3s;
}

.accordion-section.active .accordion-chevron {
  transform:rotate(180deg);
}

.accordion-content {
  max-height:0; overflow:hidden;
  transition:max-height .3s ease-out;
}

.accordion-section.active .accordion-content {
  max-height:1000px;
}

.accordion-body {
  padding:0;
}

/* Excel-style Table */
.excel-table {
  width:100%; border-collapse:collapse;
  font-size:0.875rem;
}

.excel-table tbody tr:nth-child(even) {
  background:var(--panel-b);
}

.excel-table tbody tr:hover {
  background:rgba(132, 22, 23, 0.1);
}

.excel-table td {
  padding:0.75rem 1rem;
  border-bottom:1px solid var(--line);
}

.excel-table td:first-child {
  font-weight:500; color:var(--muted);
  width:35%; font-size:0.8rem;
  text-transform:uppercase; letter-spacing:0.3px;
}

.excel-table td:last-child {
  font-family:'JetBrains Mono', monospace;
  color:var(--ink);
}

.excel-table td.empty {
  color:var(--muted); font-style:italic;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content { flex-direction:column; gap:1rem; }
  .clip-info-bar { flex-direction:column; align-items:flex-start; gap:1rem; }
  .clip-meta { flex-direction:column; align-items:flex-start; gap:0.5rem; }
  .stats-summary { grid-template-columns:repeat(2, 1fr); }
}

@media (max-width: 480px) {
  .stats-summary { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<header class="header">
  <div class="header-content">
    <h1>OU WBB Defensive Analytics</h1>
    <div class="header-actions">
     <button class="btn" onclick="goBackToDashboard()">‚Üê Back</button>
      <button class="btn primary" onclick="exportData()">‚¨á Export</button>
    </div>
  </div>
</header>

<div class="container">
  
  <!-- Clip Info Bar -->
  <div class="clip-info-bar">
    <div class="clip-title">Game 1 vs Iowa ‚Äî Q1, Possession 5</div>
    <div class="clip-meta">
      <span class="clip-meta-item"><strong>Situation:</strong> Half Court</span>
      <span class="clip-meta-item"><strong>Play:</strong> Horns Flare</span>
      <span class="clip-meta-item"><strong>Actions:</strong> Flare, DHO</span>
      <span class="clip-meta-item"><strong>Sequence:</strong> Horns ‚Üí Flare ‚Üí DHO</span>
      <span class="clip-meta-item"><strong>Result:</strong> Made FG (2 pts)</span>
    </div>
  </div>

  <!-- Main Content: Video + Analytics -->
  <div class="main-content">
    
    <!-- Video Section -->
    <div class="video-section">
      <div class="video-container">
        <div class="video-placeholder">[ Video Player: 00:45 - 00:58 ]</div>
      </div>
    </div>

    <!-- Analytics Section -->
    <div class="analytics-section">
      <div class="analytics-header">
        <span class="analytics-icon">üìä</span>
        <span class="analytics-title">Analytics & Insights</span>
      </div>
      
      <!-- Summary Stats -->
      <div class="stats-summary">
        <div class="stat-card">
          <div class="stat-value">1.32</div>
          <div class="stat-label">PPP Allowed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">67%</div>
          <div class="stat-label">Stop Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">23%</div>
          <div class="stat-label">SOS %</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">0.95</div>
          <div class="stat-label">EPV</div>
        </div>
      </div>

      <!-- Notes -->
      <div class="notes-box">
        <div class="notes-label">Notes</div>
        <div class="notes-value">Defender got stuck on flare screen, allowing clean catch-and-shoot 3. Need to communicate earlier and fight over top.</div>
      </div>

    </div>

  </div>

  <!-- Accordion Sections (Excel-style Tables) -->
  <div class="accordion-container">
    
    <!-- Context & Identifiers -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        <div class="accordion-title">
          <span class="accordion-icon">üìã</span>
          <span>Context & Identifiers</span>
        </div>
        <div class="accordion-chevron">‚ñº</div>
      </div>
      <div class="accordion-content">
        <div class="accordion-body">
          <table class="excel-table">
            <tbody>
              <tr>
                <td>Game #</td>
                <td>1</td>
              </tr>
              <tr>
                <td>Opponent</td>
                <td>Iowa</td>
              </tr>
              <tr>
                <td>Quarter</td>
                <td>Q1</td>
              </tr>
              <tr>
                <td>Possession #</td>
                <td>5</td>
              </tr>
              <tr>
                <td>Situation</td>
                <td>Half Court</td>
              </tr>
              <tr>
                <td>Offensive Formation</td>
                <td>Horns</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Play & Actions -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        <div class="accordion-title">
          <span class="accordion-icon">üéØ</span>
          <span>Play & Actions</span>
        </div>
        <div class="accordion-chevron">‚ñº</div>
      </div>
      <div class="accordion-content">
        <div class="accordion-body">
          <table class="excel-table">
            <tbody>
              <tr>
                <td>Play Name</td>
                <td>Horns Flare</td>
              </tr>
              <tr>
                <td>Action Trigger</td>
                <td>Entry to wing</td>
              </tr>
              <tr>
                <td>Action Type(s)</td>
                <td>Flare, DHO</td>
              </tr>
              <tr>
                <td>Action Sequence</td>
                <td>Horns ‚Üí Flare ‚Üí DHO</td>
              </tr>
              <tr>
                <td>Covered in Scout?</td>
                <td>Yes ‚Äî Practiced</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Defensive Components -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        <div class="accordion-title">
          <span class="accordion-icon">üõ°Ô∏è</span>
          <span>Defensive Components</span>
        </div>
        <div class="accordion-chevron">‚ñº</div>
      </div>
      <div class="accordion-content">
        <div class="accordion-body">
          <table class="excel-table">
            <tbody>
              <tr>
                <td>Defensive Coverage</td>
                <td>Man</td>
              </tr>
              <tr>
                <td>Ball Screen Coverage</td>
                <td>Under</td>
              </tr>
              <tr>
                <td>Off-Ball Screen Coverage</td>
                <td>Over</td>
              </tr>
              <tr>
                <td>Help/Rotation</td>
                <td>Low-Man Help</td>
              </tr>
              <tr>
                <td>Defensive Disruption</td>
                <td class="empty">‚Äî</td>
              </tr>
              <tr>
                <td>Defensive Breakdown</td>
                <td>Yes (Stuck on Flare)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Results & Outcome -->
    <div class="accordion-section">
      <div class="accordion-header" onclick="toggleAccordion(this)">
        <div class="accordion-title">
          <span class="accordion-icon">üé¨</span>
          <span>Results & Outcome</span>
        </div>
        <div class="accordion-chevron">‚ñº</div>
      </div>
      <div class="accordion-content">
        <div class="accordion-body">
          <table class="excel-table">
            <tbody>
              <tr>
                <td>Play Result</td>
                <td>Made FG</td>
              </tr>
              <tr>
                <td>Paint Touches</td>
                <td>No Paint Touch</td>
              </tr>
              <tr>
                <td>Shooter Designation</td>
                <td>Blue</td>
              </tr>
              <tr>
                <td>Shot Location</td>
                <td>Wing/Top 3 (22-23 ft)</td>
              </tr>
              <tr>
                <td>Shot Contest</td>
                <td>Light Contest (2-4 ft)</td>
              </tr>
              <tr>
                <td>Rebound Outcome</td>
                <td>N/A</td>
              </tr>
              <tr>
                <td>Points</td>
                <td>2</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
const API_URL = 'http://127.0.0.1:8000'; // your running media_server.py
const DASHBOARD_FALLBACK = 'clip_dashboard_refined.html';

// Get clip ID from URL parameter
const urlParams = new URLSearchParams(window.location.search);
const clipId = urlParams.get('id');

// --- Cache where we came from (helps when Safari/new tab strips referrer) ---
document.addEventListener('DOMContentLoaded', () => {
  const ref = (document.referrer || '').toLowerCase();
  const looksLikeDashboard =
    ref.includes('dashboard') ||
    ref.includes('clip_dashboard') ||
    ref.includes('clip_dashboard_refined');

  if (looksLikeDashboard) {
    sessionStorage.setItem('returnToDashboard', document.referrer);
  }
});

// --- Fetch real clip details from Flask API ---
if (clipId) {
  fetch(`${API_URL}/api/clip/${clipId}`)
    .then(res => res.json())
    .then(clip => {
      if (clip.error) {
        document.body.innerHTML = `<p style="color:white;text-align:center;padding:2rem;">‚ùå ${clip.error}</p>`;
        return;
      }

      // Header info
      document.querySelector('.clip-title').textContent =
        `Game ${clip.game_num} vs ${clip.opponent} ‚Äî Q${clip.quarter}, Possession ${clip.possession}`;

      const metaItems = document.querySelectorAll('.clip-meta-item');
      metaItems[0].innerHTML = `<strong>Situation:</strong> ${clip.situation || '‚Äî'}`;
      metaItems[1].innerHTML = `<strong>Play:</strong> ${clip.play_name || '‚Äî'}`;
      metaItems[2].innerHTML = `<strong>Actions:</strong> ${clip.action_types || '‚Äî'}`;
      metaItems[3].innerHTML = `<strong>Sequence:</strong> ${clip.action_sequence || '‚Äî'}`;
      metaItems[4].innerHTML = `<strong>Result:</strong> ${clip.play_result || '‚Äî'} (${clip.points || 0} pts)`;

      // Video player
      const videoContainer = document.querySelector('.video-container');
      const clipPath = clip.filename ? `${API_URL}/clips/${clip.filename}` : '';
      if (clipPath) {
        videoContainer.innerHTML = `
          <video controls autoplay style="width:100%;height:100%;border-radius:8px;">
            <source src="${clipPath}" type="video/mp4">
            Your browser does not support video playback.
          </video>`;
      } else {
        videoContainer.innerHTML = `<div class="video-placeholder">No video available</div>`;
      }

      // Notes
      document.querySelector('.notes-value').textContent = clip.notes || '‚Äî';

      // Tables
      updateAccordionTables({
        game: clip.game_num,
        opponent: clip.opponent,
        quarter: clip.quarter,
        possession: clip.possession,
        situation: clip.situation,
        formation: clip.offensive_formation,
        playName: clip.play_name,
        actionTrigger: clip.action_trigger,
        actionTypes: clip.action_types,
        actionSequence: clip.action_sequence,
        scoutCoverage: clip.scout_coverage,
        coverage: clip.defensive_coverage,
        ballScreen: clip.ball_screen_coverage,
        offBallScreen: clip.offball_screen_coverage,
        helpRotation: clip.help_rotation,
        disruption: clip.defensive_disruption,
        breakdown: clip.defensive_breakdown,
        result: clip.play_result,
        paintTouch: clip.paint_touches,
        shooter: clip.shooter_designation,
        shotLocation: clip.shot_location,
        contest: clip.shot_contest,
        rebound: clip.rebound_outcome,
        points: clip.points
      });
    })
    .catch(err => {
      console.error('Error loading clip:', err);
      document.body.innerHTML =
        `<p style="color:white;text-align:center;padding:2rem;">‚ö†Ô∏è Failed to load clip data.</p>`;
    });
}

function updateAccordionTables(clip) {
  // Context & Identifiers
  const contextRows = document.querySelectorAll('.accordion-section:nth-of-type(1) .excel-table tbody tr');
  contextRows[0].children[1].textContent = clip.game ?? '‚Äî';
  contextRows[1].children[1].textContent = clip.opponent ?? '‚Äî';
  contextRows[2].children[1].textContent = (clip.quarter ? 'Q' + clip.quarter : '‚Äî');
  contextRows[3].children[1].textContent = clip.possession ?? '‚Äî';
  contextRows[4].children[1].textContent = clip.situation ?? '‚Äî';
  contextRows[5].children[1].textContent = clip.formation ?? '‚Äî';

  // Play & Actions
  const playRows = document.querySelectorAll('.accordion-section:nth-of-type(2) .excel-table tbody tr');
  playRows[0].children[1].textContent = clip.playName ?? '‚Äî';
  playRows[1].children[1].textContent = clip.actionTrigger ?? '‚Äî';
  playRows[2].children[1].textContent = clip.actionTypes ?? '‚Äî';
  playRows[3].children[1].textContent = clip.actionSequence ?? '‚Äî';
  playRows[4].children[1].textContent = clip.scoutCoverage ?? '‚Äî';

  // Defensive Components
  const defenseRows = document.querySelectorAll('.accordion-section:nth-of-type(3) .excel-table tbody tr');
  defenseRows[0].children[1].textContent = clip.coverage ?? '‚Äî';
  defenseRows[1].children[1].textContent = clip.ballScreen ?? '‚Äî';
  defenseRows[2].children[1].textContent = clip.offBallScreen ?? '‚Äî';
  defenseRows[3].children[1].textContent = clip.helpRotation ?? '‚Äî';
  defenseRows[4].children[1].textContent = clip.disruption ?? '‚Äî';
  defenseRows[5].children[1].textContent = clip.breakdown ?? '‚Äî';

  // Results & Outcome
  const resultsRows = document.querySelectorAll('.accordion-section:nth-of-type(4) .excel-table tbody tr');
  resultsRows[0].children[1].textContent = clip.result ?? '‚Äî';
  resultsRows[1].children[1].textContent = clip.paintTouch ?? '‚Äî';
  resultsRows[2].children[1].textContent = clip.shooter ?? '‚Äî';
  resultsRows[3].children[1].textContent = clip.shotLocation ?? '‚Äî';
  resultsRows[4].children[1].textContent = clip.contest ?? '‚Äî';
  resultsRows[5].children[1].textContent = clip.rebound ?? '‚Äî';
  resultsRows[6].children[1].textContent = (clip.points ?? '‚Äî');
}

function toggleAccordion(headerEl) {
  const section = headerEl.parentElement;
  section.classList.toggle('active');
}

function exportData() {
  alert('Export clip data to CSV/Excel');
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.accordion-section').forEach(s => s.classList.remove('active'));
  }
  if (e.metaKey && e.key.toLowerCase() === 'a') {
    e.preventDefault();
    document.querySelectorAll('.accordion-section').forEach(s => s.classList.add('active'));
  }
});

/**
 * Smart Back:
 * 1) If we have navigation history in this tab, try going back.
 * 2) Else, if we cached a dashboard URL earlier, go there.
 * 3) Else, fall back to a known dashboard file.
 */
function goBackToDashboard() {
  const ref = (document.referrer || '').toLowerCase();
  const lookedLikeDashboard =
    ref.includes('dashboard') ||
    ref.includes('clip_dashboard') ||
    ref.includes('clip_dashboard_refined');

  const cached = sessionStorage.getItem('returnToDashboard');

  if (lookedLikeDashboard && window.history.length > 1) {
    window.history.back();
    return;
  }

  if (cached) {
    window.location.href = cached;
    return;
  }

  window.location.href = DASHBOARD_FALLBACK; // change if your file name differs
}
</script>

</body>
</html>
